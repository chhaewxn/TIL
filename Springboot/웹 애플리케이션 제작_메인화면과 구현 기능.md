# ğŸ“ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì œì‘(3)
## ë©”ì¸í™”ë©´ê³¼ êµ¬í˜„ ê¸°ëŠ¥
ğŸ”»íšŒì› ê¸°ëŠ¥
- íšŒì› ë“±ë¡
- íšŒì› ëª©ë¡ ì¡°íšŒ

ğŸ”»ìƒí’ˆ ê¸°ëŠ¥
- ìƒí’ˆ ë“±ë¡
- ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
- ìƒí’ˆ ìˆ˜ì •

ğŸ”» ì£¼ë¬¸ ê¸°ëŠ¥
- ìƒí’ˆ ì£¼ë¬¸
- ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ
- ì£¼ë¬¸ ì·¨ì†Œ

â• êµ¬í˜„í•˜ì§€ ì•Šì„ ê¸°ëŠ¥
: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹¨ìˆœí™”í•˜ê¸° ìœ„í•´ í•µì‹¬ ê¸°ëŠ¥ë§Œ êµ¬í˜„í•¨!
- ë¡œê·¸ì¸ê³¼ ê¶Œí•œ ê´€ë¦¬ëŠ” í•˜ì§€ ì•ŠëŠ”ë‹¤.
- íŒŒë¼ë¯¸í„° ê²€ì¦ê³¼ ì˜ˆì™¸ ì²˜ë¦¬ëŠ” í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ìƒí’ˆì€ ë„ì„œë§Œ ì‚¬ìš©í•œë‹¤.
- ì¹´í…Œê³ ë¦¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë°°ì†¡ ì •ë³´ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

### 11.3.1 ê°œë°œ ë°©ë²•
ê³„ì¸µí˜• êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ë©°
![](https://velog.velcdn.com/images/chhaewxn/post/f3b5cbe3-a2bb-40c6-b538-a002cb191d4e/image.png)
ê°œë°œ ìˆœì„œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ì™€ ë¦¬í¬ì§€í† ë¦¬ ê³„ì¸µì„ ë¨¼ì € ê°œë°œí•˜ê³  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‘ì„±í•´ì„œ ê²€ì¦í•œ í›„, ê²€ì¦ì„ ì™„ë£Œí•˜ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë·°ë¥¼ ê°œë°œí•˜ëŠ” ìˆœì„œë¡œ ì§„í–‰

**- Controller**
: MVCì˜ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ëª¨ì—¬ ìˆëŠ” ê³³ìœ¼ë¡œ, ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì„ í˜¸ì¶œí•˜ê³  ê²°ê³¼ë¥¼ ë·°(JSP)ì— ì „ë‹¬
**- Service**
: ì„œë¹„ìŠ¤ ê³„ì¸µì—ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë©°, ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ í˜¸ì¶œ
**- Repository**
: JPAë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê³³ì€ ë¦¬í¬ì§€í† ë¦¬ ê³„ì¸µì´ë©°, ì—¬ê¸°ì„œ ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ì‚¬ìš©í•´ì„œ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê³  ì¡°íšŒí•¨
**- Domain**
: ì—”í‹°í‹°ê°€ ëª¨ì—¬ ìˆëŠ” ê³„ì¸µìœ¼ë¡œ, ëª¨ë“  ê³„ì¸µì—ì„œ ì‚¬ìš©í•¨

### 11.3.2 íšŒì› ê¸°ëŠ¥
- íšŒì› ë“±ë¡
- íšŒì› ì¡°íšŒ

**íšŒì› ê¸°ëŠ¥ ì½”ë“œ**

1) ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì„¤ëª…í•œ íšŒì› ì—”í‹°í‹° ì½”ë“œ
```java
@Entity
public class Member {

    @Id @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;

    private String name;

    @Embedded
    private Address address;

    @OneToMany(mappedBy = "member")
    private List<Order> orders = new ArrayList<Order>();
    ...
}
```

2) íšŒì› ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•  íšŒì› ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ

- @Repository ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ ìˆìœ¼ë©´ <context:component-scan>ì— ì˜í•´ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ìë™ ë“±ë¡
- ë˜í•œ JPA ì „ìš© ì—ì™¸ê°€ ë°œìƒí•˜ë©´ ìŠ¤í”„ë§ì´ ì¶”ìƒí™”í•œ ì˜ˆì™¸ë¡œ ë³€í™˜í•´ ì¤Œ
ì˜ˆ) ë¦¬í¬ì§€í† ë¦¬ ê³„ì¸µì—ì„œ JPA ì˜ˆì™¸ì¸ NoResultExceptionì´ ë°œìƒí•˜ë©´ ìŠ¤í”„ë§ì´ ì¶”ìƒí™”í•œ ì˜ˆì™¸ì¸ EmptyResultDataAccessExceptionìœ¼ë¡œ ë³€í™˜í•´ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë°˜í™˜
- ë”°ë¼ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì€ JPAì— ì˜ì¡´ì ì¸ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šì•„ë„ ë¨ 
   
```java
@Repository
public class MemberRepository {

       @PersistenceUnit
       EntityManagerFactory emf; */
    @PersistenceContext // ì—”í‹°í‹° ë§¤ë‹ˆì € ì£¼ì…
    EntityManager em;

    // íšŒì› ì—”í‹°í‹°ë¥¼ ì €ì¥ (ì˜ì†í™”)
    public void save(Member member) {
        em.persist(member);
    }

    // íšŒì› ì‹ë³„ìë¡œ íšŒì› ì—”í‹°í‹°ë¥¼ ì¡°íšŒ
    public Member findOne(Long id) {
        return em.find(Member.class, id);
    }

    public List<Member> findAll() {
        return em.createQuery("select m from Member m", Member.class)
                .getResultList();
    }

    // JPQLì„ ì‚¬ìš©í•´ì„œ ì´ë¦„(name)ìœ¼ë¡œ íšŒì› ì—”í‹°í‹°ë“¤ì„ ì¡°íšŒ
    public List<Member> findByName(String name) {
        return em.createQuery("select m from Member m where m.name = :name", Member.class)
                .setParameter("name", name)
                .getResultList();
    }
}
```

ìˆœìˆ˜ ìë°” í™˜ê²½ì—ì„œëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì—ì„œ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ì§ì ‘ ìƒì„±í•´ì„œ ì‚¬ìš©í–ˆì§€ë§Œ, ìŠ¤í”„ë§ì´ë‚˜ J2EE ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ê´€ë¦¬í•˜ê³  ì œê³µí•´ì¤Œ. ë”°ë¼ì„œ ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ì—ì„œ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ì§ì ‘ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ @PersistenceContext ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì»¨í…Œì´ë„ˆê°€ ì œê³µí•˜ëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©! ë§Œì•½ ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ë¥¼ ì§ì ‘ ì£¼ì…ë°›ìœ¼ë ¤ë©´ @PersistenceUnit ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
    
3) íšŒì›ê³¼ ê´€ë ¨ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” íšŒì› ì„œë¹„ìŠ¤ ì½”ë“œ
```java
// @Service ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ ìˆëŠ” í´ë˜ìŠ¤ëŠ” <context:conponent-scan>ì— ì˜í•´ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ 
@Service
/* ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ëŠ” @Transcational ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ ìˆëŠ” í´ë˜ìŠ¤ë‚˜ ë©”ì†Œë“œì— íŠ¸ëœì­ì…˜ì„ ì ìš©
   ì™¸ë¶€ì—ì„œ ì´ í´ë˜ìŠ¤ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•  ë•Œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ë©”ì†Œë“œë¥¼ ì¢…ë£Œí•  ë•Œ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹
   ë§Œì•½ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°± */
@Transactional
public class MemberService {

    // ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ì ì ˆí•œ ìŠ¤í”„ë§ ë¹ˆì„ ì£¼ì…í•´ì¤Œ
    @Autowired 
    MemberRepository memberRepository; // ì—¬ê¸°ì„œëŠ” íšŒì› ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì£¼ì…

    /* íšŒì› ê°€ì…
       validateDuplicateMember()ë¡œ ê°™ì€ ì´ë¦„ì„ ê°€ì§„ íšŒì›ì´ ìˆëŠ”ì§€ ê²€ì¦í•˜ê³  
       ê²€ì¦ì„ ì™„ë£Œí•˜ë©´ íšŒì› ë¦¬í¬ì§™ë¦¬ì— íšŒì› ì €ì¥ì„ ìš”ì²­
       ë§Œì•½ ê°™ì€ ì´ë¦„ì„ ê°€ì§„ íšŒì›ì´ ì¡´ì¬í•´ì„œ ê²€ì¦ì— ì‹¤íŒ¨í•˜ë©´ 
       "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤"ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ê°€ì§€ëŠ” ì˜ˆì™¸ ë°œìƒ
       íšŒì›ê°€ì…ì— ì„±ê³µí•˜ë©´ ìƒì„±ëœ íšŒì› ì‹ë³„ìë¥¼ ë°˜í™˜ */
    public Long join(Member member) {

        validateDuplicateMember(member); // ì¤‘ë³µ íšŒì› ê²€ì¦
        memberRepository.save(member);
        return member.getId();
    }

    private void validateDuplicateMember(Member member) {
        List<Member> findMembers = memberRepository.findByName(member.getName());
        if (!findMembers.isEmpty()) {
            throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");
        }
    }

    /**
     * ì „ì²´ íšŒì› ì¡°íšŒ
     */
    public List<Member> findMembers() {
        return memberRepository.findAll();
    }

    public Member findOne(Long memberId) {
        return memberRepository.findOne(memberId);
    }
}
```

ğŸ”» íšŒì› ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
ê°œë°œí•œ íšŒì› ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì •ìƒ ë™ì‘í•˜ëŠ” JUnitìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì„œ ê²€ì¦í•´ì•¼í•¨

â• íšŒì› ê¸°ëŠ¥ì—ì„œ ê²€ì¦í•´ì•¼ í•  í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

- íšŒì›ê°€ì…ì„ ì„±ê³µí•´ì•¼ í•œë‹¤.
- íšŒì›ê°€ì… í•  ë•Œ ê°™ì€ ì´ë¦„ì´ ìˆìœ¼ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.

```java 
/* í…ŒìŠ¤íŠ¸ë¥¼ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì™€ í•¨ê»˜ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì™€ JUnitì„ í†µí•©, ì´ë ‡ê²Œ í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ê°€ ì œê³µí•˜ëŠ” @Autowired ê°™ì€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ */
@RunWith(SpringJUnit4ClassRunner.class)
/* í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•  ë•Œ ì‚¬ìš©í•  ìŠ¤í”„ë§ ì„¤ì • ì •ë³´ë¥¼ ì§€ì •
   ì—¬ê¸°ì„œëŠ” ì„¤ì • ì •ë³´ë¡œ appConfig.xmlì„ ì§€ì •
   ì°¸ê³ ë¡œ ì›¹ê³¼ ê´€ë ¨ëœ ì •ë³´ëŠ” í•„ìš”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ webAppConfig.xmlì€ ì§€ì •í•˜ì§€ ì•Šì•˜ìŒ */
@ContextConfiguration(locations = "classpath:appConfig.xml")
/* í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë³µí•´ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•˜ëŠ”ë° 
   íšŒì›ê°€ì… í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— íšŒì› ë°ì´í„°ê°€ ì €ì¥ë¨
   ê·¸ë¦¬ê³  ë‹¤ì‹œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ì´ë¯¸ ì €ì¥ëœ ë°ì´í„° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤.
   ê·¸ëŸ¬ë¯€ë¡œ @Transactionalì„ ì‚¬ìš©í•˜ë©´ ê°ê°ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  
   í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ íŠ¸ëœì­ì…˜ì„ ê°•ì œë¡œ ë¡¤ë°±í•˜ê¸° ë•Œë¬¸ì—
   í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œ ë°ì´í„°ê°€ í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë¡¤ë°±ë˜ë¯€ë¡œ
   ë°˜ë³µí•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŒ */
@Transactional
public class MemberServiceTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

    /* íšŒì› ì—”í‹°í‹°ë¥¼ í•˜ë‚˜ ìƒì„±í•˜ê³  join() ë©”ì†Œë“œë¡œ íšŒì›ê°€ì…ì„ ì‹œë„
       ê·¸ë¦¬ê³  ì‹¤ì œ íšŒì›ì´ ì €ì¥ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•˜ê¸° ìœ„í•´ 
       ë¦¬í¬ì§€í† ë¦¬ì—ì„œ íšŒì› idë¡œ íšŒì›ì„ ì°¾ì•„ì„œ ì €ì¥í•œ íšŒì›ê³¼ ê°™ì€ì§€ asserEqualsë¡œ ê²€ì¦ */ 
    @Test
    public void íšŒì›ê°€ì…() throws Exception {

        // Given
        Member member = new Member();
        member.setName("kim");

        // When
        Long saveId = memberService.join(member);

        // Then
        assertEquals(member, memberRepository.findOne(saveId));
    }

    /* íšŒì›ì€ ì¤‘ë³µìœ¼ë¡œ ì €ì¥ë˜ë©´ ì•ˆ ë˜ê³  ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•¨
       @Test.expected ì†ì„±ì— ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ì§€ì •í•˜ë©´ í…ŒìŠ¤íŠ¸ì˜ ê²°ê³¼ë¡œ ì§€ì •í•œ ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µ
       ê·¸ëŸ¬ë¯€ë¡œ ì´ë²ˆ í…ŒìŠ¤íŠ¸ëŠ” ì´ë¦„ì´ ì¤‘ë³µëœ íšŒì›ì´ ê°€ì…í–ˆì„ ë•Œ ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•˜ëŠ” í…ŒìŠ¤íŠ¸ì´ë¯€ë¡œ
       ë”°ë¼ì„œ í…ŒìŠ¤íŠ¸ì˜ ê²°ê³¼ë¡œ IllegalStateExceptionì´ ë°œìƒí•´ì•¼ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•¨
       ì´ë¦„ì´ kimì¸ ê°™ì€ íšŒì›ì´ ë‘ ëª… ê°€ì…í•˜ëŠ”ë°, 
       ë‘ ë²ˆì§¸ íšŒì›ê°€ì… ì‹œì— íšŒì›ê°€ì… ê²€ì¦ ë¡œì§ì—ì„œ IllegalStateExceptionì´ ë°œìƒ
       ë”°ë¼ì„œ ë§ˆì§€ë§‰ì˜ fail()ì€ í˜¸ì¶œë˜ì§€ ì•Šê²Œ ë˜ë©°
       ë§Œì•½ fail()ì„ í˜¸ì¶œí•˜ê±°ë‚˜ IllegalStateException ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤íŒ¨í•˜ê²Œ ë¨ */
    @Test(expected = IllegalStateException.class)
    public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() throws Exception {

        // Given
        Member member1 = new Member();
        member1.setName("kim");

        Member member2 = new Member();
        member2.setName("kim");

        // When
        memberService.join(member1);
        memberService.join(member2); // ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.

        // Then
        fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");
    }
    
}
```

### 11.3.3 ìƒí’ˆ ê¸°ëŠ¥
- ìƒí’ˆ ë“±ë¡
- ìƒí’ˆ ìˆ˜ì •
- ìƒí’ˆ ëª©ë¡ ì¡°íšŒ

**ìƒí’ˆ ê¸°ëŠ¥ ì½”ë“œ**

1) ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì„¤ëª…í•œ ìƒí’ˆ ì—”í‹°í‹° ì½”ë“œ
- ì¬ê³  ê´€ë ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì†Œë“œë„ ì¡´ì¬!

```java
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "DTYPE")
public abstract class Item {

    @Id @GeneratedValue
    @Column(name = "ITEM_ID")
    private Long id;

    private String name; // ì´ë¦„
    private int price; // ê°€ê²©
    private int stockQuantity; // ì¬ê³ ìˆ˜ëŸ‰

    @ManyToMany(mappedBy = "items")
    private List<Category> categories = new ArrayList<Category>();

    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    /* íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ìˆ˜ë§Œí¼ ì¬ê³ ë¥¼ ëŠ˜ë¦¼
       ì¬ê³ ê°€ ì¦ê°€í•˜ê±°ë‚˜ ìƒí’ˆ ì£¼ë¬¸ì„ ì·¨ì†Œí•´ì„œ ì¬ê³ ë¥¼ ë‹¤ì‹œ ëŠ˜ë ¤ì•¼ í•  ë•Œ ì‚¬ìš© */
    public void addStock(int quantity) {
        this.stockQuantity += quantity;
    }

    /* íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ìˆ˜ë§Œí¼ ì¬ê³ ë¥¼ ì¤„ì„
       ë§Œì•½ ì¬ê³ ê°€ ë¶€ì¡±í•˜ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©°, ì£¼ë¡œ ìƒí’ˆì„ ì£¼ë¬¸í•  ë•Œ ì‚¬ìš© */
    public void removeStock(int quantity) {
        int restStock = this.stockQuantity - quantity;
        if (restStock < 0) {
            throw new NotEnoughStockException("need more stock");
        }
        this.stockQuantity = restStock;
    }
    ...
}
```

2) ìƒí’ˆ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•  ìƒí’ˆ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ
```java
@Repository
public class ItemRepository {

    @PersistenceContext
    EntityManager em;

    /* ì €ì¥ê³¼ ìˆ˜ì •(ë³‘í•©)ì„ ë‹¤ ì²˜ë¦¬í•¨
       ì‹ë³„ì ê°’ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ íŒë‹¨í•´ì„œ persist()ë¡œ ì˜ì†í™”í•˜ê³ 
       ë§Œì•½ ì‹ë³„ì ê°’ì´ ìˆìœ¼ë©´ ì´ë¯¸ í•œ ë²ˆ ì˜ì†í™” ë˜ì—ˆë˜ ì—”í‹°í‹°ë¡œ íŒë‹¨í•´ì„œ merge()ë¡œ ìˆ˜ì •(ë³‘í•©)
       ê²°êµ­ ì—¬ê¸°ì„œì˜ ì €ì¥ì´ë¼ëŠ” ì˜ë¯¸ëŠ” ì‹ ê·œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒë¿ë§Œ ì•„ë‹ˆë¼
       ë³€ê²½ëœ ë°ì´í„°ì˜ ì €ì¥ì´ë¼ëŠ” ì˜ë¯¸ë„ í¬í•¨í•˜ë¯€ë¡œ 
       ì´ ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ëŠ” ì €ì¥ê³¼ ìˆ˜ì •ì„ êµ¬ë¶„í•˜ì§€ ì•Šì•„ë„ ë˜ì–´ í´ë¼ì´ì–¸íŠ¸ì˜ ë¡œì§ì´ ë‹¨ìˆœí•´ì§
       ì—¬ê¸°ì„œ ì‚¬ìš©í•˜ëŠ” ìˆ˜ì •(ë³‘í•©)ì€ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•  ë•Œ ì‚¬ìš©í•˜ë©°
       ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ëŠ” ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì´ ë™ì‘í•´ì„œ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•  ë•Œ ìë™ìœ¼ë¡œ ìˆ˜ì •ë˜ë¯€ë¡œ
       ë³„ë„ì˜ ìˆ˜ì • ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŒ */
    public void save(Item item) {
        if (item.getId() == null) {
            em.persist(item);
        } else {
            em.merge(item);
        }
    }

    public Item findOne(Long id) {
        return em.find(Item.class, id);
    }

    public List<Item> findAll() {
        return em.createQuery("select i from Item i",Item.class).getResultList();
    }
}
```

3) ìƒí’ˆ ë¦¬í¬ì§€í† ë¦¬ì— ìœ„ì„ë§Œ í•˜ëŠ” ë‹¨ìˆœí•œ ìƒí’ˆ ì„œë¹„ìŠ¤ ì½”ë“œ
```java
@Service
@Transactional
public class ItemService {

    @Autowired
    ItemRepository itemRepository;

    public void saveItem(Item item) {
        itemRepository.save(item);
    }

    public List<Item> findItems() {
        return itemRepository.findAll();
    }

    public Item findOne(Long itemId) {
        return itemRepository.findOne(itemId);
    }
}
```

### 11.3.4 ì£¼ë¬¸ ê¸°ëŠ¥

- ìƒí’ˆ ì£¼ë¬¸
- ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ
- ì£¼ë¬¸ ì·¨ì†Œ

ì§€ê¸ˆê¹Œì§€ ì‚´í´ë³¸ íšŒì›ê³¼ ìƒí’ˆ ê¸°ëŠ¥ì€ ë‹¨ìˆœí•œ CRUDê°€ ëŒ€ë¶€ë¶„ì´ì§€ë§Œ ì£¼ë¬¸ì—ëŠ” ì˜ë¯¸ ìˆëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì¡´ì¬í•œë‹¤!

**ì£¼ë¬¸ ê¸°ëŠ¥ ì½”ë“œ**
ì£¼ë¬¸ ê¸°ëŠ¥ì„ ë¶„ì„í•˜ë ¤ë©´ ì£¼ë¬¸ ì—”í‹°í‹°ì™€ ì£¼ë¬¸ìƒí’ˆ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì‚´í´ë´ì•¼ í•œë‹¤

1) ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì„¤ëª…í•œ ì£¼ë¬¸ ì—”í‹°í‹° ì½”ë“œ
```java
@Entity
@Table(name = "ORDERS")
public class Order {

    @Id @GeneratedValue
    @Column(name = "ORDER_ID")
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "MEMBER_ID")
    private Member member; // ì£¼ë¬¸ íšŒì›

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<OrderItem>();

    @OneToOne(cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    @JoinColumn(name = "DELIVERY_ID")
    private Delivery delivery; // ë°°ì†¡ì •ë³´

    private Date orderDate; // ì£¼ë¬¸ì‹œê°„

    @Enumerated(EnumType.STRING)
    private OrderStatus status; // ì£¼ë¬¸ìƒíƒœ

    //==ìƒì„± ë©”ì„œë“œ==//
    /* ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©
       ì£¼ë¬¸ íšŒì›, ë°°ì†¡ì •ë³´, ì£¼ë¬¸ìƒí’ˆì˜ ì •ë³´ë¥¼ ë°›ì•„ì„œ ì‹¤ì œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ìƒì„± */
    public static Order createOrder(Member member, Delivery delivery, OrderItem... orderItems) {

        Order order = new Order();
        order.setMember(member); 
        order.setDelivery(delivery); 
        for (OrderItem orderItem : orderItems) { 
            order.addOrderItem(orderItem);
        }
        order.setStatus(OrderStatus.ORDER);
        order.setOrderDate(new Date());
        return order;
    }

    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    /* ì£¼ë¬¸ ì·¨ì†Œ 
       ì£¼ë¬¸ ì·¨ì†Œ ì‹œ ì‚¬ìš©
       ì£¼ë¬¸ ìƒíƒœë¥¼ ì·¨ì†Œë¡œ ë³€ê²½í•˜ê³  ì£¼ë¬¸ìƒí’ˆì— ì£¼ë¬¸ ì·¨ì†Œë¥¼ ì•Œë¦¼
       ë§Œì•½ ì´ë¯¸ ë°°ì†¡ì„ ì™„ë£Œí•œ ìƒí’ˆì´ë©´ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì§€ ëª»í•˜ë„ë¡ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚´ */
    public void cancel() {

        if (delivery.getStatus() == DeliveryStatus.COMP) {
            throw new RuntimeException("ì´ë¯¸ ë°°ì†¡ì™„ë£Œëœ ìƒí’ˆì€ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        this.setStatus(OrderStatus.CANCEL);
        for (OrderItem orderItem : orderItems) {
            orderItem.cancel();
        }
    }

    //==ì¡°íšŒ ë¡œì§==//
    /* ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ 
       ì£¼ë¬¸ ì‹œ ì‚¬ìš©í•œ ì „ì²´ ì£¼ë¬¸ ê°€ê²©ì„ ì¡°íšŒ
       ì „ì²´ ì£¼ë¬¸ ê°€ê²©ì„ ì•Œë ¤ë©´ ê°ê°ì˜ ì£¼ë¬¸ìƒí’ˆ ê°€ê²©ì„ ì•Œì•„ì•¼ í•¨
       ë¡œì§ì„ ë³´ë©´ ì—°ê´€ëœ ì£¼ë¬¸ìƒí’ˆë“¤ì˜ ê°€ê²©ì„ ì¡°íšŒí•´ì„œ ë”í•œ ê°’ì„ ë°˜í™˜ */
    public int getTotalPrice() {
        int totalPrice = 0;
        for (OrderItem orderItem : orderItems) {
            totalPrice += orderItem.getTotalPrice();
        }
        return totalPrice;
    }
    
    ...
}
```

2) ë„ë©”ì¸ ëª¨ë¸ì—ì„œ ì„¤ëª…í•œ ì£¼ë¬¸ìƒí’ˆ ì—”í‹°í‹° ì½”ë“œ
```java
@Entity
@Table(name = "ORDER_ITEM")
public class OrderItem {

    @Id @GeneratedValue
    @Column(name = "ORDER_ITEM_ID")
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "ITEM_ID")
    private Item item; // ì£¼ë¬¸ ìƒí’ˆ

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "ORDER_ID")
    private Order order; // ì£¼ë¬¸

    private int orderPrice; // ì£¼ë¬¸ ê°€ê²©
    private int count; // ì£¼ë¬¸ ìˆ˜ëŸ‰

    //==ìƒì„± ë©”ì„œë“œ==//
    /* ì£¼ë¬¸ ìƒí’ˆ, ê°€ê²©, ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ì‚¬ìš©í•´ì„œ ì£¼ë¬¸ ìƒí’ˆ ì—”í‹°í‹°ë¥¼ ìƒì„±
       ê·¸ë¦¬ê³  item.removeStock(count)ë¥¼ í˜¸ì¶œí•´ì„œ ì£¼ë¬¸í•œ ìˆ˜ëŸ‰ë§Œí¼ ìƒí’ˆì˜ ì¬ê³ ë¥¼ ì¤„ì„ */
    public static OrderItem createOrderItem(Item item, int orderPrice, int count) {

        OrderItem orderItem = new OrderItem();
        orderItem.setItem(item);
        orderItem.setOrderPrice(orderPrice);
        orderItem.setCount(count);

        item.removeStock(count);
        return orderItem;
    }

    //==ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    /* ì£¼ë¬¸ ì·¨ì†Œ 
       getItem().addStock(count)ë¥¼ í˜¸ì¶œí•´ì„œ ì·¨ì†Œí•œ ì£¼ë¬¸ ìˆ˜ëŸ‰ë§Œí¼ ìƒí’ˆì˜ ì¬ê³ ë¥¼ ì¦ê°€ì‹œí‚´ */
    public void cancel() {
        getItem().addStock(count);
    }

    //==ì¡°íšŒ ë¡œì§==//
    /* ì£¼ë¬¸ìƒí’ˆ ì „ì²´ ê°€ê²© ì¡°íšŒ 
       ì£¼ë¬¸ ê°€ê²©ì— ìˆ˜ëŸ‰ì„ ê³±í•œ ê°’ì„ ë°˜í™˜ */
    public int getTotalPrice() {
        return getOrderPrice() * getCount();
    }
    ...
}
```

3) ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ì €ì¥, ê²€ìƒ‰í•˜ê³  ê´€ë¦¬í•  ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ
```java
@Repository
public class OrderRepository {

    @PersistenceContext
    EntityManager em;

    public void save(Order order) {
        em.persist(order);
    }

    public Order findOne(Long id) {
        return em.find(Order.class, id);
    }

    /* í™”ë©´ì—ì„œ íšŒì› ì´ë¦„ê³¼ ì£¼ë¬¸ ìƒíƒœë¥¼ ì„ íƒí•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ 
       OrderSearch ê°ì²´ë¥¼ í†µí•´ ê²€ìƒ‰ ì¡°ê±´ì´ ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ì˜ findAll() ë©”ì†Œë“œë¡œ ì „ë‹¬ë˜ë©°,
       findAll() ë©”ì†Œë“œëŠ” ì´ ê²€ìƒ‰ ì¡°ê±´ì„ í™œìš©í•´ì„œ ì£¼ë¬¸ ìƒí’ˆì„ ê²€ìƒ‰ 
       findAll() ë©”ì†Œë“œëŠ” ê²€ìƒ‰ ì¡°ê±´ì— ë”°ë¼ Criteriaë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±í•´ì„œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ */
    public List<Order> findAll(OrderSearch orderSearch) { // ì£¼ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥

        CriteriaBuilder cb = em.getCriteriaBuilder();
        CriteriaQuery<Order> cq = cb.createQuery(Order.class);
        Root<Order> o = cq.from(Order.class);

        List<Predicate> criteria = new ArrayList<Predicate>();

        // ì£¼ë¬¸ ìƒíƒœ ê²€ìƒ‰
        if (orderSearch.getOrderStatus() != null) {
            Predicate status = cb.equal(o.get("status"), orderSearch.getOrderStatus());
            criteria.add(status);
        }
        // íšŒì› ì´ë¦„ ê²€ìƒ‰
        if (StringUtils.hasText(orderSearch.getMemberName())) {
            Join<Order, Member> m = o.join("member", JoinType.INNER); // íšŒì›ê³¼ ì¡°ì¸
            Predicate name = cb.like(m.<String>get("name"), "%" + orderSearch.getMemberName() + "%");
            criteria.add(name);
        }

        cq.where(cb.and(criteria.toArray(new Predicate[criteria.size()])));
        TypedQuery<Order> query = em.createQuery(cq).setMaxResults(1000); // ìµœëŒ€ ê²€ìƒ‰ 1000 ê±´ìœ¼ë¡œ ì œí•œ
        return query.getResultList();
    }
}
```

4) ì£¼ë¬¸ê³¼ ê´€ë ¨ëœ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” íšŒì› ì„œë¹„ìŠ¤ ì½”ë“œ 
- ì£¼ë¬¸ ì—”í‹°í‹°ì™€ ì£¼ë¬¸ìƒí’ˆ ì—”í‹°í‹°ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í™œìš©í•´ì„œ ì£¼ë¬¸, ì£¼ë¬¸ ì·¨ì†Œ, ì£¼ë¬¸ ë‚´ì—­ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì œê³µ

```java
@Service
@Transactional
public class OrderService {

    @Autowired MemberRepository memberRepository;
    @Autowired OrderRepository orderRepository;
    @Autowired ItemService itemService;

    /* ì£¼ë¬¸ 
       ì£¼ë¬¸í•˜ëŠ” íšŒì› ì‹ë³„ì, ìƒí’ˆ ì‹ë³„ì, ì£¼ë¬¸ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ë°›ì•„ì„œ ì‹¤ì œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ìƒì„±í•œ í›„ ì €ì¥ */
    public Long order(Long memberId, Long itemId, int count) {

        // ì—”í‹°í‹° ì¡°íšŒ
        Member member = memberRepository.findOne(memberId);
        Item item = itemService.findOne(itemId);
 
        // ë°°ì†¡ì •ë³´ ìƒì„±
        Delivery delivery = new Delivery(member.getAddress());
        // ì£¼ë¬¸ìƒí’ˆ ìƒì„±
        OrderItem orderItem = OrderItem.createOrderItem(item, item.getPrice(), count);
        // ì£¼ë¬¸ ìƒì„±
        Order order = Order.createOrder(member, delivery, orderItem);

        // ì£¼ë¬¸ ì €ì¥
        orderRepository.save(order);
        return order.getId();
    }


    /* ì£¼ë¬¸ ì·¨ì†Œ 
       ì£¼ë¬¸ ì‹ë³„ìë¥¼ ë°›ì•„ì„œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œ í›„ ì£¼ë¬¸ ì—”í‹°í‹°ì— ì£¼ë¬¸ ì·¨ì†Œë¥¼ ìš”ì²­ */
    public void cancelOrder(Long orderId) {

        // ì£¼ë¬¸ ì—”í‹°í‹° ì¡°íšŒ
        Order order = orderRepository.findOne(orderId);

        // ì£¼ë¬¸ ì·¨ì†Œ
        order.cancel();
    }

    /* ì£¼ë¬¸ ê²€ìƒ‰
       ê²€ìƒ‰ ì¡°ê±´ì„ ê°€ì§„ ê°ì²´ë¡œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ê²€ìƒ‰ */
    public List<Order> findOrders(OrderSearch orderSearch) {
        return orderRepository.findAll(orderSearch);
    }

}
```

5) ì£¼ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥
íšŒì› ì´ë¦„ê³¼ ì£¼ë¬¸ ìƒíƒœë¥¼ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì£¼ë¬¸ ë‚´ì—­ì„ ê²€ìƒ‰í•˜ëŠ” ê¸°ëŠ¥

```java
/* í™”ë©´ì—ì„œ íšŒì› ì´ë¦„ê³¼ ì£¼ë¬¸ ìƒíƒœë¥¼ ì„ íƒí•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ 
   OrderSearch ê°ì²´ë¥¼ í†µí•´ ê²€ìƒ‰ ì¡°ê±´ì´ ì£¼ë¬¸ ë¦¬í¬ì§€í† ë¦¬ì˜ findAll() ë©”ì†Œë“œë¡œ ì „ë‹¬ë˜ë©°,
   findAll() ë©”ì†Œë“œëŠ” ì´ ê²€ìƒ‰ ì¡°ê±´ì„ í™œìš©í•´ì„œ ì£¼ë¬¸ ìƒí’ˆì„ ê²€ìƒ‰ */
public class OrderSearch {

    private String memberName; // íšŒì› ì´ë¦„
    private OrderStatus orderStatus; // ì£¼ë¬¸ ìƒíƒœ

    // Getter, Setter
    public String getMemberName() {
        return memberName;
    }

    public void setMemberName(String memberName) {
        this.memberName = memberName;
    }

    public OrderStatus getOrderStatus() {
        return orderStatus;
    }

    public void setOrderStatus(OrderStatus orderStatus) {
        this.orderStatus = orderStatus;
    }
}
```

**ì£¼ë¬¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸**

â• ì£¼ë¬¸ ê¸°ëŠ¥ì—ì„œ ê²€ì¦í•´ì•¼ í•  í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- ìƒí’ˆ ì£¼ë¬¸ì´ ì„±ê³µí•´ì•¼ í•œë‹¤.
- ìƒí’ˆì„ ì£¼ë¬¸í•  ë•Œ ì¬ê³  ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•˜ë©´ ì•ˆ ëœë‹¤.
- ì£¼ë¬¸ ì·¨ì†Œê°€ ì„±ê³µí•´ì•¼ í•œë‹¤.
```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:appConfig.xml")
@Transactional
// @TransactionConfiguration(defaultRollback = false)
public class OrderServiceTest {

    @PersistenceContext
    EntityManager em;

    @Autowired OrderService orderService;
    @Autowired OrderRepository orderRepository;

    /* ìƒí’ˆ ì£¼ë¬¸ í…ŒìŠ¤íŠ¸
       Given ì ˆì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ íšŒì›ê³¼ ìƒí’ˆì„ ë§Œë“¤ê³ 
       When ì ˆì—ì„œ ì‹¤ì œ ìƒí’ˆì„ ì£¼ë¬¸í•˜ê³ 
       Then ì ˆì—ì„œ ì£¼ë¬¸ ê°€ê²©ì´ ì˜¬ë°”ë¥¸ì§€, ì£¼ë¬¸ í›„ ì¬ê³  ìˆ˜ëŸ‰ì´ ì •í™•íˆ ì¤„ì—ˆëŠ”ì§€ ê²€ì¦ */
    @Test
    public void ìƒí’ˆì£¼ë¬¸() throws Exception {

        // Given
        Member member = createMember();
        Item item = createBook("ì‹œê³¨ JPA", 10000, 10); // ì´ë¦„, ê°€ê²©, ì¬ê³ 
        int orderCount = 2;

        // When
        Long orderId = orderService.order(member.getId(), item.getId(), orderCount);

        // Then
        Order getOrder = orderRepository.findOne(orderId);

        assertEquals("ìƒí’ˆ ì£¼ë¬¸ì‹œ ìƒíƒœëŠ” ì£¼ë¬¸(ORDER)ì´ë‹¤.", OrderStatus.ORDER, getOrder.getStatus());
        assertEquals("ì£¼ë¬¸í•œ ìƒí’ˆ ì¢…ë¥˜ ìˆ˜ê°€ ì •í™•í•´ì•¼ í•œë‹¤.", 1, getOrder.getOrderItems().size());
        assertEquals("ì£¼ë¬¸ ê°€ê²©ì€ ê°€ê²© * ìˆ˜ëŸ‰ì´ë‹¤.", 10000 * 2, getOrder.getTotalPrice());
        assertEquals("ì£¼ë¬¸ ìˆ˜ëŸ‰ë§Œí¼ ì¬ê³ ê°€ ì¤„ì–´ì•¼ í•œë‹¤.", 8, item.getStockQuantity());
    }

    /* ì¬ê³  ìˆ˜ëŸ‰ ì´ˆê³¼ í…ŒìŠ¤íŠ¸ 
       ì¬ê³  ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•´ì„œ ìƒí’ˆì„ ì£¼ë¬¸í•˜ë©´ NotEnoughStockException ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•¨ */
    @Test(expected = NotEnoughStockException.class)
    public void ìƒí’ˆì£¼ë¬¸_ì¬ê³ ìˆ˜ëŸ‰ì´ˆê³¼() throws Exception {

        // Given
        Member member = createMember();
        Item item = createBook("ì‹œê³¨ JPA", 10000, 10); // ì´ë¦„, ê°€ê²©, ì¬ê³ 

        int orderCount = 11; // ì¬ê³  ë³´ë‹¤ ë§ì€ ìˆ˜ëŸ‰ (ì¬ê³  : 10ê°œ, ì£¼ë¬¸ : 11ê°œ)

        // When
        orderService.order(member.getId(), item.getId(), orderCount);

        // Then
        fail("ì¬ê³  ìˆ˜ëŸ‰ ë¶€ì¡± ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");
    }

    /* ì£¼ë¬¸ ì·¨ì†Œ í…ŒìŠ¤íŠ¸ 
       ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ë©´ ê·¸ë§Œí¼ ì¬ê³ ê°€ ì¦ê°€í•´ì•¼ í•¨
       Given ì ˆì—ì„œ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ê¸° ìœ„í•´ ë¨¼ì € ì£¼ë¬¸í•˜ê³ 
       When ì ˆì—ì„œ í•´ë‹¹ ì£¼ë¬¸ì„ ì·¨ì†Œ
       Then ì ˆì—ì„œ ì£¼ë¬¸ìƒíƒœê°€ ì£¼ë¬¸ ì·¨ì†Œ ìƒíƒœì¸ì§€, ì·¨ì†Œí•œ ë§Œí¼ ì¬ê³ ê°€ ì¦ê°€í–ˆëŠ”ì§€ ê²€ì¦ */
    @Test
    public void ì£¼ë¬¸ì·¨ì†Œ() {

        // Given
        Member member = createMember();
        Item item = createBook("ì‹œê³¨ JPA", 10000, 10); // ì´ë¦„, ê°€ê²©, ì¬ê³ 
        int orderCount = 2;

        Long orderId = orderService.order(member.getId(), item.getId(), orderCount);

        // When
        orderService.cancelOrder(orderId);

        // Then
        Order getOrder = orderRepository.findOne(orderId);

        assertEquals("ì£¼ë¬¸ ì·¨ì†Œì‹œ ìƒíƒœëŠ” CANCEL ì´ë‹¤.", OrderStatus.CANCEL, getOrder.getStatus());
        assertEquals("ì£¼ë¬¸ì´ ì·¨ì†Œëœ ìƒí’ˆì€ ê·¸ë§Œí¼ ì¬ê³ ê°€ ì¦ê°€í•´ì•¼ í•œë‹¤.", 10, item.getStockQuantity());
    }

    private Member createMember() {
        Member member = new Member();
        member.setName("íšŒì›1");
        member.setAddress(new Address("ì„œìš¸", "ê°•ê°€", "123-123"));
        em.persist(member);
        return member;
    }

    private Book createBook(String name, int price, int stockQuantity) {
        Book book = new Book();
        book.setName(name);
        book.setStockQuantity(stockQuantity);
        book.setPrice(price);
        em.persist(book);
        return book;
    }
}
```

### 11.3.5 ì›¹ ê³„ì¸µ êµ¬í˜„

**ìƒí’ˆ ë“±ë¡**
ì›¹ í™”ë©´ì—ì„œ ìƒí’ˆì„ ì–´ë–»ê²Œ ë“±ë¡í•˜ëŠ”ì§€, ìƒí’ˆ ì»¨íŠ¸ë¡¤ëŸ¬ ì¤‘ì—ì„œ ìƒí’ˆ ë“±ë¡ ì‹œë‚˜ë¦¬ì˜¤ì— ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„

ğŸ”» ìƒí’ˆ ë“±ë¡ í¼
ì²« í™”ë©´ì—ì„œ ìƒí’ˆ ë“±ë¡ì„ ì„ íƒí•˜ë©´ /item/new URLì„ HTTP GET ë°©ì‹ìœ¼ë¡œ ìš”ì²­í•˜ê³  ìŠ¤í”„ë§ MVCëŠ” HTTP ìš”ì²­ ì •ë³´ì™€ @RequestMappingì˜ ì†ì„± ê°’ì„ ë¹„êµí•´ì„œ ì‹¤í–‰í•  ë©”ì†Œë“œë¥¼ ì°¾ì€ í›„ ìš”ì²­ ì •ë³´ì™€ ë§¤í•‘ë˜ëŠ” createForm() ë©”ì†Œë“œë¥¼ ì‹¤í–‰
createForm() ë©”ì†Œë“œëŠ” ë‹¨ìˆœíˆ items/createItemForm ë¬¸ìë¥¼ ë°˜í™˜í•˜ê³ ,
webAppConfig.xmlì— ì •ì˜ëœ ìŠ¤í”„ë§ MVCì˜ ë·° ë¦¬ì¡¸ë²„ëŠ” ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤í–‰í•  ë·°ë¥¼ ì°¾ìœ¼ë©° ë°©ê¸ˆ ë°˜í™˜í•œ ë¬¸ì(items/createItemForm)ì™€ ë·° ë¦¬ì¡¸ë²„ì— ë“±ë¡í•œ setPrefix(), setSuffix() ì •ë³´ë¥¼ ì‚¬ìš©í•´ ë Œë”ë§í•  ë·°ë¥¼ ì°¾ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ í•´ë‹¹ ìœ„ì¹˜ì˜ JSPë¥¼ ì‹¤í–‰í•œ ê²°ê³¼ HTMLì„ í´ë¼ì´ì–¸íŠ¸ì— ì‘ë‹µ

- ë³€í™˜ ì „  : items/createItemForm -> {prefix} items/createItemForm {subffix} 
- ë³€í™˜ í›„ : items/createItemForm -> /WEBINF/jsp/items/createItemForm.jsp

ğŸ”» ìƒí’ˆ ë“±ë¡
ìƒí’ˆ ë“±ë¡ í¼ì—ì„œ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  Submit ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ /items/newë¥¼ POST ë°©ì‹ìœ¼ë¡œ ìš”ì²­í•˜ê³  ìš”ì²­ ì •ë³´ì™€ ë§¤í•‘ë˜ëŠ” ìƒí’ˆ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ create(Book item) ë©”ì†Œë“œë¥¼ ì‹¤í–‰

íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œ itemì—ëŠ” í™”ë©´ì—ì„œ ì…ë ¥í•œ ë°ì´í„°ê°€ ëª¨ë‘ ë°”ì¸ë”©ë˜ì–´ ìˆìŒ
(HttpServeletRequestì˜ íŒŒë¼ë¯¸í„°ì™€ ê°ì²´ì˜ í”„ë¡œí¼í‹° ì´ë¦„ì„ ë¹„êµí•´ì„œ ê°™ìœ¼ë©´ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ê°€ ê°’ì„ ë°”ì¸ë”©í•´ì¤Œ)

ì´ ë©”ì†Œë“œëŠ” ìƒí’ˆ ì„œë¹„ìŠ¤ê°€ ìƒí’ˆ ì €ì¥ì„ ìš”ì²­(itemService.saveItem(item))í›„ ì €ì¥ì´ ëë‚˜ë©´ ìƒí’ˆ ëª©ë¡ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
```java
// ìƒí’ˆ ë“±ë¡
@Controller
public class ItemController {

    @Autowired ItemService itemService;

    @RequestMapping(value = "/items/new", method = RequestMethod.GET)
    public String createForm() {
        return "items/createItemForm";
    }

    @RequestMapping(value = "/items/new", method = RequestMethod.POST)
    public String create(Book item) {

        itemService.saveItem(item);
        return "redirect:/items";
    }
    ...
}
// webAppConfig.xmlì— ë“±ë¡í•œ ë·° ë¦¬ì¡¸ë²„
// ìŠ¤í”„ë§ ë¹ˆì„ ë“±ë¡ (JSP, JSTLì„ ì‚¬ìš©í•˜ë„ë¡ ë·° ë¦¬ì¡¸ë²„ë¥¼ ìŠ¤í”„ë§ ë¹ˆì„ ë“±ë¡)
<bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
    <property name="viewClass" value="org.springframework.web.servlet.view.JstlView"/>
    <property name="prefix" value="/WEB-INF/jsp/"/>
    <property name="suffix" value=".jsp"/>
</bean>
```

ğŸ”» ìƒí’ˆ ëª©ë¡
í™”ë©´ì—ì„œ ìƒí’ˆ ëª©ë¡ì˜ URLì€ /itemsì´ë©°, ìƒí’ˆ ëª©ë¡ì„ í´ë¦­í•˜ë©´ ItemControllerì— ìˆëŠ” list() ë©”ì†Œë“œë¥¼ ì‹¤í–‰
```java
@Controller
public class ItemController {

    @Autowired ItemService itemService;

    ...

    /* ìƒí’ˆ ëª©ë¡ 
       itemService.findItems()ë¥¼ í˜¸ì¶œí•´ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ìƒí’ˆ ëª©ë¡ì„ ì¡°íšŒ
       ê·¸ë¦¬ê³  ì¡°íšŒí•œ ìƒí’ˆì„ ë·°ì— ì „ë‹¬í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ MVCê°€ ì œê³µí•˜ëŠ” ëª¨ë¸ ê°ì²´ì— ë‹´ì•„ë‘ 
       ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰í•  ë·° ì´ë¦„ì„ ë°˜í™˜ */
    @RequestMapping(value = "/items", method = RequestMethod.GET)
    public String list(Model model) {

        List<Item> items = itemService.findItems();
        model.addAttribute("items", items);
        return "items/itemList";
    }
}
// itemList.jsp
// ëª¨ë¸ì— ë‹´ì•„ë‘” ìƒí’ˆ ëª©ë¡ì¸ itemsë¥¼ êº¼ë‚´ì„œ ìƒí’ˆ ì •ë³´ë¥¼ ì¶œë ¥
...
<c:forEach items="${items}" var="item">
...
```

ğŸ”» ìƒí’ˆ ìˆ˜ì •
- ìƒí’ˆ ëª©ë¡ í™”ë©´ì—ì„œ ìˆ˜ì • ë²„íŠ¼ì„ ì„ íƒí•˜ë©´ ìƒí’ˆ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ì´ë™

ìƒí’ˆ ìˆ˜ì • í¼
- ìˆ˜ì • ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ /items/{itemId}/edit URLì„ GET ë°©ì‹ìœ¼ë¡œ ìš”ì²­í•˜ì—¬ updateItemForm() ë©”ì†Œë“œë¥¼ ì‹¤í–‰ì‹œí‚¤ë©°, ì´ ë©”ì†Œë“œëŠ” itemService.findOne(itemId)ë¥¼ í˜¸ì¶œí•´ì„œ ìˆ˜ì •í•  ìƒí’ˆì„ ì¡°íšŒ
ê·¸ë¦¬ê³  ì¡°íšŒ ê²°ê³¼ë¥¼ ëª¨ë¸ ê°ì²´ì— ë‹´ì•„ì„œ ë·°(items/updateItemForm)ì— ì „ë‹¬

- ìƒí’ˆ ìˆ˜ì • í¼ HTMLì—ëŠ” ìƒí’ˆì˜ id(hidden), ìƒí’ˆëª…, ê°€ê²©, ìˆ˜ëŸ‰ ì •ë³´ê°€ ìˆìŒ. ìƒí’ˆ ìˆ˜ì • í¼ì—ì„œ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  Submit ë²„íŠ¼ì„ ì„ íƒí•˜ë©´ /items/{itemId}/edit URLì„ POST ë°©ì‹ìœ¼ë¡œ ìš”ì²­í•˜ê³  updataItem() ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ë©°, ì´ë•Œ ì»¨íŠ¸ë¡¤ëŸ¬ì— íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ item ì—”í‹°í‹° ì¸ìŠ¤í„´ìŠ¤ëŠ” í˜„ì¬ ì¤€ì˜ì† ìƒíƒœ, ë”°ë¼ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ì§€ì›ì„ ë°›ì„ ìˆ˜ ì—†ê³  ë°ì´í„°ë¥¼ ìˆ˜ì •í•´ë„ ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì„ ë™ì‘í•˜ì§€ ì•ŠëŠ” ë¬¸ì œ ë°œìƒ

ê·¸ëŸ¬ë¯€ë¡œ ì•„ë˜ì˜ ë³€ê²½ ê°ì§€ ë˜ëŠ” ë³‘í•©ì„ ì´ìš©
updateItem() ë©”ì†Œë“œëŠ” itemService.saveItem(item)ì„ í˜¸ì¶œí•´ì„œ ì¤€ì˜ì† ìƒíƒœì¸ item ì—”í‹°í‹°ë¥¼ ìƒí’ˆ ì„œë¹„ìŠ¤ì— ì „ë‹¬
ìƒí’ˆ ì„œë¹„ìŠ¤ëŠ” íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ìƒí’ˆ ë¦¬í¬ì§€í† ë¦¬ì— ì €ì¥ì„ ìš”ì²­í•˜ëŠ”ë°
ì´ ë©”ì†Œë“œëŠ” ì‹ë³„ìê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¡œ íŒë‹¨í•´ì„œ ì˜ì†í™”í•˜ê³ 
ì‹ë³„ìê°€ ìˆìœ¼ë©´ ë³‘í•©ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ ì¤€ì˜ì† ìƒíƒœì¸ ìƒí’ˆ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•  ë•ŒëŠ” id ê°’ì´ ìˆìœ¼ë¯€ë¡œ ë³‘í•©ì„ ìˆ˜í–‰! ê·¸ëŸ¬ë¯€ë¡œ ìˆ˜ì • ì‚¬í•­ì´ ë°˜ì˜ë¨

```java
@Controller
public class ItemController {

    @Autowired ItemService itemService;

    ...
    
    /* ìƒí’ˆ ìˆ˜ì • í¼ */
    @RequestMapping(value = "/items/{itemId}/edit", method = RequestMethod.GET)
    public String updateItemForm(@PathVariable("itemId") Long itemId, Model model) {

        Item item = itemService.findOne(itemId);
        model.addAttribute("item", item);
        return "items/updateItemForm";
    }

    /* ìƒí’ˆ ìˆ˜ì • */
    @RequestMapping(value = "/items/{itemId}/edit", method = RequestMethod.POST)
    public String updateItem(@ModelAttribute("item") Book item) {

        itemService.saveItem(item);
        return "redirect:/items";
    }
    ...
}
```

#### ë³€ê²½ ê°ì§€ì™€ ë³‘í•©

ì¤€ì˜ì† ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ ì¡´ì¬
- ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ ì‚¬ìš©
: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•œ í›„ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ
íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ìë¡œ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì–»ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì˜ì† ìƒíƒœì¸ ì—”í‹°í‹°ì˜ ê°’ì„ íŒŒë¼ë¯¸í„°ë¡œ ì—„ì–´ì˜¨ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹° ê°’ìœ¼ë¡œ ë³€ê²½ ì´ë ‡ê²Œ í•˜ë©´ ì´í›„ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë  ë•Œ ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì´ ë™ì‘í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆ˜ì •ì‚¬í•­ì´ ë°˜ì˜ë¨

- ë³‘í•© ì‚¬ìš©
: íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸´ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ ì˜ì† ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œ í›„
ì˜ì† ì—”í‹°í‹°ì˜ ê°’ì„ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ê°’ìœ¼ë¡œ ì±„ì›Œ ë„£ìŒ

ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì›í•˜ëŠ” ì†ì„±ë§Œ ì„ íƒí•´ì„œ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ ë³‘í•©ì„ ì‚¬ìš©í•˜ë©´ ëª¨ë“  ì†ì„±ì´ ë³€ê²½ë¨

```java
// ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ ì‚¬ìš©
@Transactional
// itemParam : íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°
void update(Item itemParam) {
 
    // ê°™ì€ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ
    Item findItem = em.find(Item.class, itemParam.getId());
    
    findItem.setPrice(itemParam.getPrice()); // ë°ì´í„°ë¥¼ ìˆ˜ì •
}

// ë³‘í•© ì‚¬ìš©
@Transactional
// itemParam : íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°
void update(Item itemParam) {
 
    Item mergetItem = em.merge(item);
}
```

### ìƒí’ˆ ì£¼ë¬¸

ğŸ”» ìƒí’ˆ ì£¼ë¬¸ í¼
- ë©”ì¸ í™”ë©´ì—ì„œ ìƒí’ˆ ì£¼ë¬¸ì„ ì„ íƒí•˜ë©´ /orderë¥¼ GET ë°©ì‹ìœ¼ë¡œ í˜¸ì¶œí•´ì„œ OrderControllerì˜ createForm() ë©”ì†Œë“œë¥¼ ì‹¤í–‰
- ì£¼ë¬¸ í™”ë©´ì—ëŠ” ì£¼ë¬¸í•  ê³ ê°ì •ë³´ì™€ ìƒí’ˆ ì •ë³´ê°€ í•„ìš”í•˜ë¯€ë¡œ ëª¨ë¸ ê°ì²´ì— ë‹´ì•„ì„œ ë·°ì— ë„˜ê²¨ì¤Œ

ğŸ”» ìƒí’ˆ ì£¼ë¬¸ 
- ìƒí’ˆ ì£¼ë¬¸ í™”ë©´ì—ì„œ ì£¼ë¬¸í•  íšŒì›ê³¼ ìƒí’ˆ ê·¸ë¦¬ê³  ìˆ˜ëŸ‰ì„ ì„ íƒí•´ Submit ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ /order URLì„ POST ë°©ì‹ìœ¼ë¡œ í˜¸ì¶œí•´ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ order() ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ê³ , ì´ëŠ” ê³ ê° ì‹ë³„ì, ì£¼ë¬¸í•  ìƒí’ˆ ì‹ë³„ì, ìˆ˜ëŸ‰ ì •ë³´ë¥¼ ë°›ì•„ì„œ ì£¼ë¬¸ ì„œë¹„ìŠ¤ì— ì£¼ë¬¸ì„ ìš”ì²­
- ì£¼ë¬¸ì´ ëë‚˜ë©´ ìƒí’ˆ ì£¼ë¬¸ ë‚´ì—­ì´ ìˆëŠ” /order URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

```java
@Controller
public class OrderController {

    @Autowired OrderService orderService;
    @Autowired MemberService memberService;
    @Autowired ItemService itemService;

    @RequestMapping(value = "/order", method = RequestMethod.GET)
    public String createForm(Model model) {

        List<Member> members = memberService.findMembers();
        List<Item> items = itemService.findItems();

        model.addAttribute("members", members);
        model.addAttribute("items", items);

        return "order/orderForm";
    }

    @RequestMapping(value = "/order", method = RequestMethod.POST)
    public String order(@RequestParam("memberId") Long memberId, @RequestParam("itemId") Long itemId, @RequestParam("count") int count) {

        orderService.order(memberId, itemId, count);
        return "redirect:/orders";
    }
    ...
}
```
